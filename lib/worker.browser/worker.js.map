{"version":3,"sources":["../../src/worker.browser/worker.js"],"names":[],"mappings":"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","file":"worker.js","sourcesContent":["import EventEmitter from 'eventemitter3';\nimport slaveCodeDataUri from './slave-code-uri';\n\nimport { getConfig } from '../config';\n\n\nif (typeof window.Worker !== 'object' && typeof window.Worker !== 'function') {\n  throw new Error('Browser does not support web workers!');\n}\n\n\nfunction joinPaths (path1, path2) {\n  if (!path1 || !path2) {\n    return path1 + path2;\n  } else if (path1.charAt(path1.length - 1) === '/' || path2.charAt(0) === '/') {\n    return path1 + path2;\n  } else {\n    return path1 + '/' + path2;\n  }\n}\n\nfunction prependScriptUrl(scriptUrl) {\n  const prefix = getConfig().basepath.web;\n  return prefix ? joinPaths(prefix, scriptUrl) : scriptUrl;\n}\n\nfunction convertToArray(input) {\n  let outputArray = [];\n  let index = 0;\n\n  while (typeof input[index] !== 'undefined') {\n    outputArray.push(input[index]);\n    index++;\n  }\n\n  return outputArray;\n}\n\nfunction logError(error) {\n  if (error.stack) {\n    console.error(error.stack);                                             // eslint-disable-line no-console\n  } else if (error.message && error.filename && error.lineno) {\n    const fileName = error.filename.match(/^data:text\\/javascript/) && error.filename.length > 50\n                   ? error.filename.substr(0, 50) + '...'\n                   : error.filename;\n    console.error(`${error.message} @${fileName}:${error.lineno}`);   // eslint-disable-line no-console\n  } else {\n    console.error(error);                                                   // eslint-disable-line no-console\n  }\n}\n\n\nexport default class Worker extends EventEmitter {\n  constructor(initialScript = null, importScripts = []) {\n    super();\n\n    // used by `run()` to decide if the worker must be re-initialized\n    this.currentRunnable = null;\n    this.currentImportScripts = [];\n\n    this.initWorker();\n    this.worker.addEventListener('message', this.handleMessage.bind(this));\n    this.worker.addEventListener('error', this.handleError.bind(this));\n\n    if (initialScript) {\n      this.run(initialScript, importScripts);\n    }\n  }\n\n  initWorker() {\n    try {\n      this.worker = new window.Worker(slaveCodeDataUri);\n    } catch (error) {\n      const slaveScriptUrl = getConfig().fallback.slaveScriptUrl;\n      if (slaveScriptUrl) {\n        // try using the slave script file instead of the data URI\n        this.worker = new window.Worker(slaveCodeDataUri);\n      } else {\n        // re-throw\n        throw error;\n      }\n    }\n  }\n\n  run(toRun, importScripts = []) {\n    if (this.alreadyInitializedToRun(toRun, importScripts)) {\n      // don't re-initialize with the new logic if it already has been\n      return this;\n    }\n\n    if (typeof toRun === 'function') {\n      this.runMethod(toRun, importScripts);\n    } else {\n      this.runScripts(toRun, importScripts);\n    }\n\n    this.currentRunnable = toRun;\n    this.currentImportScripts = importScripts;\n\n    return this;\n  }\n\n  runMethod(method, importScripts) {\n    const methodStr = method.toString();\n    const args = methodStr.substring(methodStr.indexOf('(') + 1, methodStr.indexOf(')')).split(',');\n    const body = methodStr.substring(methodStr.indexOf('{') + 1, methodStr.lastIndexOf('}'));\n\n    this.worker.postMessage({\n      initByMethod : true,\n      method       : { args, body },\n      scripts      : importScripts.map(prependScriptUrl)\n    });\n  }\n\n  runScripts(script, importScripts) {\n    if (!script) { throw new Error('Must pass a function or a script URL to run().'); }\n\n    // attention: array for browser, single script for node\n    this.worker.postMessage({\n      initByScripts : true,\n      scripts       : importScripts.concat([ script ]).map(prependScriptUrl)\n    });\n  }\n\n  send(param, transferables = []) {\n    this.worker.postMessage({\n      doRun : true,\n      param\n    }, transferables);\n    return this;\n  }\n\n  kill() {\n    this.worker.terminate();\n    this.emit('exit');\n    return this;\n  }\n\n  promise() {\n    return new Promise((resolve, reject) => {\n      this\n        .once('message', resolve)\n        .once('error', reject);\n    });\n  }\n\n  alreadyInitializedToRun(toRun, importScripts) {\n    const runnablesMatch = this.currentRunnable === toRun;\n    const importScriptsMatch = this.currentImportScripts === importScripts\n      || (importScripts.length === 0 && this.currentImportScripts.length === 0);\n\n    return runnablesMatch && importScriptsMatch;\n  }\n\n  handleMessage(event) {\n    if (event.data.error) {\n      this.handleError(event.data.error);\n    } else if (event.data.progress) {\n      this.handleProgress(event.data.progress);\n    } else {\n      const responseArgs = convertToArray(event.data.response);\n      this.emit('message', ...responseArgs);\n      this.emit('done', ...responseArgs);    // this one is just for convenience\n    }\n  }\n\n  handleProgress(progress) {\n    this.emit('progress', progress);\n  }\n\n  handleError(error) {\n    if (!this.listeners('error', true)) {\n      logError(error);\n    }\n\n    if (error.preventDefault) {\n      error.preventDefault();\n    }\n\n    this.emit('error', error);\n  }\n}\n"]}